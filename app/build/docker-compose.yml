name: transcendence
services:
  reverse-proxy:
    build:
      context: ..
      dockerfile: infrastructure/reverse-proxy/Dockerfile
    ports:
      - "8080:80"
      - "8443:443"
    networks:
      - microservices-network
    volumes:
      - ../frontend/certs:/etc/nginx/certs:ro
      - ../infrastructure/reverse-proxy/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - gateway
    restart: "no"

  gateway:
    build: ../services/gateway
    ports:
      - "3000:3000"
    networks:
      - microservices-network
    depends_on:
      # - authentication
      - game-orchestration
      - game-engine
    restart: "no"

  authentication:
    build: ../services/authentication
    ports:
      - "3001:3001"
    networks:
      - microservices-network
    # Temporarily disabled vault dependency for testing
    environment:
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_CALLBACK_URL=https://localhost:8443/api/auth/oauth/google/callback
    restart: unless-stopped


  game-orchestration:
    build: ../services/game-orchestration
    ports:
      - "3002:3002"
    networks:
      - microservices-network
    environment:
      - GAME_ENGINE_HOST=game-engine
      - GAME_ENGINE_PORT=3003
    restart: unless-stopped

  game-engine:
    build: ../services/game-engine
    ports:
      - "3003:3003"
    networks:
      - microservices-network
    restart: "no"

networks:
  microservices-network:
    driver: bridge
