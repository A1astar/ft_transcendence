worker_processes auto;

events {
    worker_connections 1024;
}

http {
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name localhost transcendence;

        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_certificate /etc/nginx/ssl/inception.crt;
        ssl_certificate_key /etc/nginx/ssl/inception.key;

        location / {
            root /frontend/dist;
            try_files $uri $uri/ /index.html;
        }

        # location /api {
        #     proxy_pass http://localhost:3000;
        #     proxy_set_header Host $host;
        #     proxy_set_header X-Real-IP $remote_addr;
        #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        #     proxy_set_header X-Forwarded-Proto $scheme;
        # }

        # location /wc {

        # }
    }
}

########### MODSECURITY #############
# user  www-data;
# worker_processes  auto;
# pid /run/nginx.pid;

# events {
#     worker_connections  1024;
# }

# http {
#     sendfile on;
#     tcp_nopush on;
#     tcp_nodelay on;
#     keepalive_timeout 65;
#     types_hash_max_size 2048;
#     include       mime.types;
#     default_type  application/octet-stream;

#     # Proxy / client tuning
#     client_max_body_size 20M;
#     client_body_timeout 60s;
#     proxy_read_timeout 90s;
#     proxy_connect_timeout 10s;
#     proxy_send_timeout 90s;

#     # Upstream api-gateway (adjust host:port to your service)
#     upstream api_gateway {
#         # example docker service name + port; change as needed
#         server api-gateway:8080;
#         # or use IP:port or unix:/path/to/socket:;
#     }

#     # ModSecurity (libmodsecurity + nginx connector)
#     # Make sure the ModSecurity nginx module is compiled/installed.
#     # Point ModSecurityConfig to your modsecurity config file.
#     # The module supports these directives at http/server/location context.
#     modsecurity on;
#     modsec_rules_file /home/algadea/dev/42/ft_transcendence/app/reverse-proxy/modsecurity.conf-recommended;

#     # Optional global ModSecurity tuning (can be moved inside server block)
#     # modsecurity_rules 'SecRuleEngine On';  # use if you prefer inline control

#     server {
#         listen 80;
#         server_name _;

#         # Enable ModSecurity for this server (redundant if set globally above)
#         modsecurity on;
#         modsec_rules_file /home/algadea/dev/42/ft_transcendence/app/reverse-proxy/modsecurity.conf-recommended;

#         # Pass original client info to upstream
#         location / {
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#             proxy_set_header X-Forwarded-Proto $scheme;

#             # For websockets / streaming
#             proxy_http_version 1.1;
#             proxy_set_header Upgrade $http_upgrade;
#             proxy_set_header Connection $connection_upgrade;

#             # Disable buffering if you want streaming proxied as-is (useful for uploads)
#             proxy_buffering off;

#             proxy_pass http://api_gateway;
#         }

#         # Example health check path forwarded to upstream
#         location /health {
#             proxy_pass http://api_gateway/health;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#         }

#         # Static files (optional)
#         location /static/ {
#             proxy_pass http://api_gateway/static/;
#             proxy_set_header Host $host;
#             proxy_set_header X-Real-IP $remote_addr;
#         }

#         # Basic access / error logs
#         access_log /var/log/nginx/access.log;
#         error_log  /var/log/nginx/error.log warn;
#     }

#     # Include other confs if needed
#     include /etc/nginx/conf.d/*.conf;
#     include /etc/nginx/sites-enabled/*;
# }


############ FASTIFY RECOMMANDATION ###########################
# # This upstream block groups 3 servers into one named backend fastify_app
# # with 2 primary servers distributed via round-robin
# # and one backup which is used when the first 2 are not reachable
# # This also assumes your fastify servers are listening on port 80.
# # more info: https://nginx.org/en/docs/http/ngx_http_upstream_module.html
# upstream fastify_app {
#   server 10.10.11.1:80;
#   server 10.10.11.2:80;
#   server 10.10.11.3:80 backup;
# }

# # This server block asks NGINX to respond with a redirect when
# # an incoming request from port 80 (typically plain HTTP), to
# # the same request URL but with HTTPS as protocol.
# # This block is optional, and usually used if you are handling
# # SSL termination in NGINX, like in the example here.
# server {
#   # default server is a special parameter to ask NGINX
#   # to set this server block to the default for this address/port
#   # which in this case is any address and port 80
#   listen 80 default_server;
#   listen [::]:80 default_server;

#   # With a server_name directive you can also ask NGINX to
#   # use this server block only with matching server name(s)
#   # listen 80;
#   # listen [::]:80;
#   # server_name example.tld;

#   # This matches all paths from the request and responds with
#   # the redirect mentioned above.
#   location / {
#     return 301 https://$host$request_uri;
#   }
# }

# # This server block asks NGINX to respond to requests from
# # port 443 with SSL enabled and accept HTTP/2 connections.
# # This is where the request is then proxied to the fastify_app
# # server group via port 3000.
# server {
#   # This listen directive asks NGINX to accept requests
#   # coming to any address, port 443, with SSL.
#   listen 443 ssl default_server;
#   listen [::]:443 ssl default_server;

#   # With a server_name directive you can also ask NGINX to
#   # use this server block only with matching server name(s)
#   # listen 443 ssl;
#   # listen [::]:443 ssl;
#   # server_name example.tld;

#   # Enable HTTP/2 support
#   http2 on;

#   # Your SSL/TLS certificate (chain) and secret key in the PEM format
#   ssl_certificate /path/to/fullchain.pem;
#   ssl_certificate_key /path/to/private.pem;

#   # A generic best practice baseline for based
#   # on https://ssl-config.mozilla.org/
#   ssl_session_timeout 1d;
#   ssl_session_cache shared:FastifyApp:10m;
#   ssl_session_tickets off;

#   # This tells NGINX to only accept TLS 1.3, which should be fine
#   # with most modern browsers including IE 11 with certain updates.
#   # If you want to support older browsers you might need to add
#   # additional fallback protocols.
#   ssl_protocols TLSv1.3;
#   ssl_prefer_server_ciphers off;

#   # This adds a header that tells browsers to only ever use HTTPS
#   # with this server.
#   add_header Strict-Transport-Security "max-age=63072000" always;

#   # The following directives are only necessary if you want to
#   # enable OCSP Stapling.
#   ssl_stapling on;
#   ssl_stapling_verify on;
#   ssl_trusted_certificate /path/to/chain.pem;

#   # Custom nameserver to resolve upstream server names
#   # resolver 127.0.0.1;

#   # This section matches all paths and proxies it to the backend server
#   # group specified above. Note the additional headers that forward
#   # information about the original request. You might want to set
#   # trustProxy to the address of your NGINX server so the X-Forwarded
#   # fields are used by fastify.
#   location / {
#     # more info: https://nginx.org/en/docs/http/ngx_http_proxy_module.html
#     proxy_http_version 1.1;
#     proxy_cache_bypass $http_upgrade;
#     proxy_set_header Upgrade $http_upgrade;
#     proxy_set_header Connection 'upgrade';
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;

#     # This is the directive that proxies requests to the specified server.
#     # If you are using an upstream group, then you do not need to specify a port.
#     # If you are directly proxying to a server e.g.
#     # proxy_pass http://127.0.0.1:3000 then specify a port.
#     proxy_pass http://fastify_app;
#   }
# }
